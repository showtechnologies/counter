<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Countdown Evento / Capodanno</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    :root {
      --bg-color: #000000;
      --text-color: #ffffff;
      --font-size-base: 8vw;
      --count-font-family: "SF Mono", "Menlo", "Consolas", "Roboto Mono", monospace;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background-color: var(--bg-color);
      color: #eee;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .page {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    header {
      padding: 0.5rem 1rem;
      background: var(--bg-color);
      border-bottom: 1px solid #333;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
      font-size: 0.85rem;
      transition: opacity 0.3s ease;
    }

    #headerBar.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .current-time {
      font-variant-numeric: tabular-nums;
      font-size: 0.8rem;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem 0.8rem;
      align-items: center;
      position: relative; /* per ancorare popup font */
    }

    .controls label {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.8rem;
      white-space: nowrap;
    }

    .controls input[type="datetime-local"] {
      font-size: 0.8rem;
      padding: 0.1rem 0.2rem;
    }

    .controls input[type="color"] {
      -webkit-appearance: none;
      border: 1px solid #666;
      border-radius: 4px;
      width: 2rem;
      height: 1.2rem;
      padding: 0;
      background: #111;
      cursor: pointer;
    }

    .controls input[type="color"]::-webkit-color-swatch {
      border-radius: 2px;
      border: none;
    }

    .controls input[type="color"]::-webkit-color-swatch-wrapper {
      padding: 0;
    }

    .controls input[type="number"] {
      font-size: 0.8rem;
      padding: 0.1rem 0.3rem;
      width: 4rem;
    }

    .controls button {
      font-size: 0.8rem;
      padding: 0.2rem 0.6rem;
      cursor: pointer;
      border-radius: 4px;
      border: 1px solid #444;
      background: #333;
      color: #eee;
    }

    .controls button:hover {
      background: #444;
    }

    /* ---- Font picker ---- */
    .font-picker {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      position: relative;
      font-size: 0.8rem;
    }

    .font-name-label {
      min-width: 3.5rem;
      text-overflow: ellipsis;
      overflow: hidden;
      white-space: nowrap;
      opacity: 0.8;
    }

    .font-popup {
      position: absolute;
      top: 130%;
      right: 0;
      background: #111;
      border: 1px solid #555;
      border-radius: 4px;
      padding: 0.25rem;
      display: none;
      z-index: 10;
      box-shadow: 0 4px 10px rgba(0,0,0,0.7);
      max-width: min(70vw, 640px);
      flex-wrap: wrap;
      gap: 0.2rem;
    }

    .font-popup.open {
      display: flex;
    }

    .font-option {
      display: inline-flex;
      align-items: baseline;
      justify-content: flex-start;
      gap: 0.25rem;
      font-size: 0.8rem;
      padding: 0.15rem 0.45rem;
      border: none;
      background: #222;
      color: #eee;
      cursor: pointer;
      border-radius: 999px;
      white-space: nowrap;
    }

    .font-option:hover {
      background: #444;
    }

    .font-option-preview {
      font-size: 0.9rem;
    }

    .font-option-label {
      font-size: 0.72rem;
      opacity: 0.7;
    }

    .font-option.mono {
      font-family: "SF Mono","Menlo","Consolas","Roboto Mono",monospace;
    }
    .font-option.sans {
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Roboto",sans-serif;
    }
    .font-option.digital {
      font-family: "Courier New",Courier,monospace;
      letter-spacing: 0.08em;
    }
    .font-option.helvetica {
      font-family: "Helvetica Neue",Arial,sans-serif;
    }
    .font-option.verdana {
      font-family: Verdana,Geneva,sans-serif;
    }
    .font-option.trebuchet {
      font-family: "Trebuchet MS","Lucida Grande",Lucida,sans-serif;
    }
    .font-option.impact {
      font-family: Impact,Haettenschweiler,"Arial Narrow Bold",sans-serif;
      letter-spacing: 0.06em;
    }
    .font-option.gill {
      font-family: "Gill Sans","Gill Sans MT",Calibri,"Trebuchet MS",sans-serif;
    }
    .font-option.georgia {
      font-family: Georgia,"Times New Roman",serif;
    }
    .font-option.times {
      font-family: "Times New Roman",Times,serif;
    }
    .font-option.lucida {
      font-family: "Lucida Console","Lucida Sans Typewriter",monospace;
    }

    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background-color: var(--bg-color);
      color: var(--text-color);
      transition: background-color 0.2s, color 0.2s;
    }

    .countdown-wrapper {
      text-align: center;
      width: 100%;
      padding: 0 2vw;
    }

    .countdown-label {
      font-family: var(--count-font-family);
      font-size: var(--font-size-base);
      font-weight: 700;
      letter-spacing: 0.05em;
      text-shadow: 0.05em 0.05em 0.1em rgba(0, 0, 0, 0.7);
      font-variant-numeric: tabular-nums;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: clip;
    }

    #countInt {
      display: inline-block;
    }

    .countdown-label.tick {
      animation: tickSwap 260ms ease-in-out;
    }

    @keyframes tickSwap {
      0%   { transform: scale(1);    opacity: 1; }
      40%  { transform: scale(0.6);  opacity: 0; }
      55%  { transform: scale(1.25); opacity: 0; }
      100% { transform: scale(1);    opacity: 1; }
    }

    @media (max-width: 768px) {
      .controls {
        flex-direction: column;
        align-items: flex-start;
      }
      .countdown-label {
        font-size: 10vw;
      }
    }
  </style>
</head>
<body>
<div class="page">
  <header id="headerBar">
    <div>
      <div style="font-weight:600;">Countdown Evento / Capodanno (HTML)</div>
      <div class="current-time" id="currentTimeLabelLocal">Locale: --:--:--</div>
      <div class="current-time" id="currentTimeLabelServer">Server: --:--:--</div>
      <div id="syncStatus" style="font-size:0.7rem;opacity:0.7;">Sync: locale (solo orologio Mac)</div>
    </div>

    <div class="controls">
      <label>
        Target:
        <input type="datetime-local" id="targetInput">
      </label>

      <label>
        Testo:
        <input type="color" id="textColorInput" value="#ffffff">
      </label>

      <label>
        Sfondo:
        <input type="color" id="bgColorInput" value="#000000">
      </label>

      <div class="font-picker">
        <button type="button" id="fontPickerBtn">Font</button>
        <span id="fontNameLabel" class="font-name-label">Mono</span>
        <div id="fontPopup" class="font-popup">
          <button type="button" class="font-option mono"
                  data-font='"SF Mono","Menlo","Consolas","Roboto Mono",monospace'>
            <span class="font-option-preview">12:34:56</span>
            <span class="font-option-label">Mono</span>
          </button>
          <button type="button" class="font-option sans"
                  data-font='system-ui,-apple-system,BlinkMacSystemFont,"Roboto",sans-serif'>
            <span class="font-option-preview">12:34:56</span>
            <span class="font-option-label">Sans (system)</span>
          </button>
          <button type="button" class="font-option digital"
                  data-font='"Courier New",Courier,monospace'>
            <span class="font-option-preview">12:34:56</span>
            <span class="font-option-label">Digital / Courier</span>
          </button>
          <button type="button" class="font-option helvetica"
                  data-font='"Helvetica Neue",Arial,sans-serif'>
            <span class="font-option-preview">12:34:56</span>
            <span class="font-option-label">Helvetica / Arial</span>
          </button>
          <button type="button" class="font-option verdana"
                  data-font='Verdana,Geneva,sans-serif'>
            <span class="font-option-preview">12:34:56</span>
            <span class="font-option-label">Verdana</span>
          </button>
          <button type="button" class="font-option trebuchet"
                  data-font='"Trebuchet MS","Lucida Grande",Lucida,sans-serif'>
            <span class="font-option-preview">12:34:56</span>
            <span class="font-option-label">Trebuchet</span>
          </button>
          <button type="button" class="font-option impact"
                  data-font='Impact,Haettenschweiler,"Arial Narrow Bold",sans-serif'>
            <span class="font-option-preview">12:34:56</span>
            <span class="font-option-label">Impact</span>
          </button>
          <button type="button" class="font-option gill"
                  data-font='"Gill Sans","Gill Sans MT",Calibri,"Trebuchet MS",sans-serif'>
            <span class="font-option-preview">12:34:56</span>
            <span class="font-option-label">Gill Sans</span>
          </button>
          <button type="button" class="font-option georgia"
                  data-font='Georgia,"Times New Roman",serif'>
            <span class="font-option-preview">12:34:56</span>
            <span class="font-option-label">Georgia</span>
          </button>
          <button type="button" class="font-option times"
                  data-font='"Times New Roman",Times,serif'>
            <span class="font-option-preview">12:34:56</span>
            <span class="font-option-label">Times</span>
          </button>
          <button type="button" class="font-option lucida"
                  data-font='"Lucida Console","Lucida Sans Typewriter",monospace'>
            <span class="font-option-preview">12:34:56</span>
            <span class="font-option-label">Lucida Console</span>
          </button>
        </div>
      </div>

      <label>
        Dim (vw):
        <input type="number" id="fontSizeInput" min="2" max="20" step="0.5" value="8">
      </label>

      <button id="startBtn">Imposta / Riavvia</button>
      <button id="fullscreenBtn">Full screen</button>
      <span style="font-size:0.75rem;opacity:0.7;">(H: mostra/nascondi comandi)</span>
    </div>
  </header>

  <main id="countdownArea">
    <div class="countdown-wrapper">
      <div class="countdown-label" id="countdownText">
        <span id="countInt">Imposta una data di arrivo</span>
      </div>
    </div>
  </main>
</div>

<script>
  (function () {
    const countdownText         = document.getElementById("countdownText");
    const countIntSpan          = document.getElementById("countInt");
    const currentTimeLabelLocal = document.getElementById("currentTimeLabelLocal");
    const currentTimeLabelSrv   = document.getElementById("currentTimeLabelServer");
    const targetInput           = document.getElementById("targetInput");
    const textColorInput        = document.getElementById("textColorInput");
    const bgColorInput          = document.getElementById("bgColorInput");
    const fontSizeInput         = document.getElementById("fontSizeInput");
    const startBtn              = document.getElementById("startBtn");
    const fullscreenBtn         = document.getElementById("fullscreenBtn");
    const headerBar             = document.getElementById("headerBar");
    const syncStatus            = document.getElementById("syncStatus");

    const fontPickerBtn         = document.getElementById("fontPickerBtn");
    const fontPopup             = document.getElementById("fontPopup");
    const fontNameLabel         = document.getElementById("fontNameLabel");
    const fontOptions           = fontPopup.querySelectorAll(".font-option");

    let targetTime        = null;
    let timerId           = null;
    let blinkId           = null;
    let finished          = false;
    let blinkVisible      = true;
    let controlsVisible   = true;
    let lastSecondForAnim = null;
    let baseFontSize      = 8;

    let currentFontFamily = '"SF Mono","Menlo","Consolas","Roboto Mono",monospace';
    let currentFontLabel  = "Mono";

    let serverOffsetMs    = null;

    async function syncServerTime() {
      const url = "https://timeapi.io/api/Time/current/zone?timeZone=Europe/Rome";
      try {
        syncStatus.textContent = "Sync: in corso (solo lettura server)...";
        const t0 = Date.now();
        const resp = await fetch(url, { cache: "no-cache" });
        const t1 = Date.now();

        if (!resp.ok) throw new Error("HTTP " + resp.status);

        const data = await resp.json();
        if (!data.dateTime) throw new Error("Risposta inattesa dal server orario");

        const serverMs = new Date(data.dateTime).getTime();
        const rtt      = t1 - t0;
        const clientAtServer = t0 + rtt / 2;

        serverOffsetMs = serverMs - clientAtServer;
        const offsetMsRounded = Math.round(serverOffsetMs);
        syncStatus.textContent =
          `Sync: server (solo riferimento visivo, offset ~${offsetMsRounded} ms)`;
      } catch (err) {
        serverOffsetMs = null;
        syncStatus.textContent =
          "Sync: locale (server non raggiungibile, countdown usa SOLO orologio Mac)";
        console.warn("Sync orologio server fallita:", err);
      }
    }

    // >>> QUI la modifica: default = 1/1/2026 00:00 locali <<<
    function setDefaultTarget() {
      const t = new Date(2026, 0, 1, 0, 0, 0); // 1 gennaio 2026, 00:00 ora locale
      const local = new Date(t.getTime() - t.getTimezoneOffset() * 60000);
      const value = local.toISOString().slice(0, 16); // "2026-01-01T00:00"
      targetInput.value = value;
    }
    setDefaultTarget();
    // <<< fine modifica >>>

    function formatDate(d) {
      const pad = (n) => String(n).padStart(2, "0");
      const yyyy = d.getFullYear();
      const MM   = pad(d.getMonth() + 1);
      const dd   = pad(d.getDate());
      const hh   = pad(d.getHours());
      const mm   = pad(d.getMinutes());
      const ss   = pad(d.getSeconds());
      return `${dd}/${MM}/${yyyy} ${hh}:${mm}:${ss}`;
    }

    function updateCurrentTime() {
      const nowLocal = new Date();
      currentTimeLabelLocal.textContent = "Locale: " + formatDate(nowLocal);

      if (serverOffsetMs !== null) {
        const srvNow = new Date(Date.now() + serverOffsetMs);
        currentTimeLabelSrv.textContent = "Server: " + formatDate(srvNow);
      } else {
        currentTimeLabelSrv.textContent = "Server: --:--:--";
      }
    }
    setInterval(updateCurrentTime, 200);
    updateCurrentTime();

    function applyFontSettings() {
      baseFontSize = parseFloat(fontSizeInput.value) || 8;
      document.documentElement.style.setProperty("--count-font-family", currentFontFamily);
      document.documentElement.style.setProperty("--font-size-base", baseFontSize + "vw");
      fontNameLabel.textContent = currentFontLabel;
    }
    applyFontSettings();

    fontSizeInput.addEventListener("change", applyFontSettings);

    fontPickerBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      fontPopup.classList.toggle("open");
    });

    fontOptions.forEach(btn => {
      btn.addEventListener("click", (e) => {
        e.stopPropagation();
        const f = btn.getAttribute("data-font");
        const labelEl = btn.querySelector(".font-option-label");
        const label = labelEl ? labelEl.textContent.trim() : btn.textContent.trim();

        currentFontFamily = f;
        currentFontLabel  = label;
        applyFontSettings();
        fontPopup.classList.remove("open");
      });
    });

    document.addEventListener("click", () => {
      fontPopup.classList.remove("open");
    });

    fontPopup.addEventListener("click", (e) => {
      e.stopPropagation();
    });

    function setControlsVisibility(visible) {
      controlsVisible = visible;
      if (visible) {
        headerBar.classList.remove("hidden");
      } else {
        headerBar.classList.add("hidden");
        fontPopup.classList.remove("open");
      }
    }

    function updateCountdown() {
      if (!targetTime || finished) return;

      const now   = Date.now();
      let msecsTo = targetTime - now;

      if (msecsTo <= 0) {
        onFinished();
        return;
      }

      const totalSeconds = Math.floor(msecsTo / 1000);
      const days    = Math.floor(totalSeconds / 86400);
      const hours   = Math.floor((totalSeconds % 86400) / 3600);
      const minutes = Math.floor((totalSeconds % 3600) / 60);
      const seconds = totalSeconds % 60;

      const pad2 = (n) => String(n).padStart(2, "0");
      let text  = "";
      let mode  = "s";

      if (totalSeconds >= 86400) {
        mode = "dhms";
        text = `${days}:${pad2(hours)}:${pad2(minutes)}:${pad2(seconds)}`;
      } else if (totalSeconds >= 3600) {
        mode = "hms";
        text = `${pad2(hours)}:${pad2(minutes)}:${pad2(seconds)}`;
      } else if (totalSeconds >= 60) {
        mode = "ms";
        const totalMinutes = Math.floor(totalSeconds / 60);
        const s = totalSeconds % 60;
        text = `${pad2(totalMinutes)}:${pad2(s)}`;
      } else {
        mode = "s";
        if (totalSeconds === 0) {
          onFinished();
          return;
        }
        text = totalSeconds < 10 ? String(totalSeconds) : pad2(totalSeconds);
      }

      let factor = 1.0;
      if (mode === "dhms")      factor = 1.0;
      else if (mode === "hms")  factor = 1.3;
      else if (mode === "ms")   factor = 1.7;
      else if (mode === "s")    factor = 2.2;

      const effectiveSize = baseFontSize * factor;
      document.documentElement.style.setProperty("--font-size-base", effectiveSize + "vw");

      countIntSpan.textContent = text;

      if (totalSeconds !== lastSecondForAnim) {
        lastSecondForAnim = totalSeconds;
        if (totalSeconds > 0 && totalSeconds <= 10) {
          countdownText.classList.remove("tick");
          void countdownText.offsetWidth;
          countdownText.classList.add("tick");
        } else {
          countdownText.classList.remove("tick");
        }
      }
    }

    function onFinished() {
      finished = true;

      if (timerId !== null) {
        clearInterval(timerId);
        timerId = null;
      }

      countdownText.classList.remove("tick");

      document.documentElement.style.setProperty("--bg-color", "#000000");
      document.documentElement.style.setProperty("--text-color", "#ffffff");
      countIntSpan.textContent = "0";

      blinkVisible = true;
      countdownText.style.visibility = "visible";

      if (blinkId !== null) {
        clearInterval(blinkId);
      }

      blinkId = setInterval(() => {
        blinkVisible = !blinkVisible;
        countdownText.style.visibility = blinkVisible ? "visible" : "hidden";
      }, 500);
    }

    function startCountdown() {
      if (blinkId !== null) {
        clearInterval(blinkId);
        blinkId = null;
      }
      countdownText.style.visibility = "visible";
      finished = false;
      lastSecondForAnim = null;

      const value = targetInput.value;
      if (!value) {
        alert("Imposta una data/ora di arrivo.");
        return;
      }

      const localDate = new Date(value);
      if (isNaN(localDate.getTime())) {
        alert("Data/ora non valida.");
        return;
      }

      targetTime = localDate.getTime();

      const now = Date.now();
      if (targetTime <= now) {
        alert("La data/ora di arrivo deve essere nel futuro.");
        return;
      }

      if (timerId !== null) {
        clearInterval(timerId);
      }
      timerId = setInterval(updateCountdown, 100);
      updateCountdown();

      setControlsVisibility(false);
    }

    textColorInput.addEventListener("input", () => {
      document.documentElement.style.setProperty("--text-color", textColorInput.value);
    });

    bgColorInput.addEventListener("input", () => {
      document.documentElement.style.setProperty("--bg-color", bgColorInput.value);
    });

    startBtn.addEventListener("click", startCountdown);

    fullscreenBtn.addEventListener("click", () => {
      const elem = document.documentElement;
      if (!document.fullscreenElement) {
        if (elem.requestFullscreen) elem.requestFullscreen();
      } else {
        if (document.exitFullscreen) document.exitFullscreen();
      }
    });

    targetInput.addEventListener("change", () => {
      if (timerId !== null) {
        startCountdown();
      }
    });

    document.addEventListener("keydown", (event) => {
      if (event.key === "h" || event.key === "H") {
        setControlsVisibility(!controlsVisible);
      }
    });

    document.documentElement.style.setProperty("--bg-color", bgColorInput.value);
    document.documentElement.style.setProperty("--text-color", textColorInput.value);

    countIntSpan.textContent = "Imposta una data di arrivo";

    // Sync iniziale SOLO per mostrare ora server
    syncServerTime();
  })();
</script>
</body>
</html>
